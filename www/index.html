<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <title>系统主页</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="navbar">
        <div>报警系统</div>
        <div>
            <a href="index.html" class="active">首页</a>
            <a href="config.html">配置</a>
            <a href="/logout">退出</a>
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <!-- 系统信息卡片 -->
            <div class="card">
                <h2>系统信息</h2>
                <div class="info-row">
                    <strong>设备 IP:</strong>
                    <span id="ip">加载中...</span>
                    <button class="copy-btn" onclick="copyText('ip')">复制</button>
                </div>

                <div class="info-row">
                    <strong>监听地址:</strong>
                    <span id="listen">加载中...</span>
                    <button class="copy-btn" onclick="copyText('listen')">复制</button>
                </div>

                <div class="info-row">
                    <strong>推送地址:</strong>
                    <span id="target">加载中...</span>
                    <button class="copy-btn" onclick="copyText('target')">复制</button>
                </div>

            </div>

            <!-- 系统占用卡片 -->
            <div class="card">
                <h2>系统占用</h2>
                <div class="chart-container">
                    <div class="chart">
                        <svg width="120" height="120">
                            <circle class="bg" cx="60" cy="60" r="50" />
                            <circle class="value" id="cpu-circle" cx="60" cy="60" r="50" stroke-dasharray="0 314" />
                        </svg>
                        <div class="chart-text" id="cpu-text">--%</div>
                        <p style="text-align:center;">CPU</p>
                    </div>
                    <div class="chart">
                        <svg width="120" height="120">
                            <circle class="bg" cx="60" cy="60" r="50" />
                            <circle class="value" id="mem-circle" cx="60" cy="60" r="50" stroke-dasharray="0 314" />
                        </svg>
                        <div class="chart-text" id="mem-text">--%</div>
                        <p style="text-align:center;">内存</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 报警日志卡片 -->
        <div class="card log-card">
            <h2>最近报警日志</h2>
            <ul id="logs"></ul>
        </div>
    </div>

    <script>
        function copyText(id) {
            const text = document.getElementById(id).textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert("已复制: " + text);
            });
        }

        fetch("/system-info")
            .then(res => res.json())
            .then(data => {
                document.getElementById("ip").textContent = data.ip;
                document.getElementById("listen").textContent = `http://${data.ip}:${data.port}${data.path}`;
                document.getElementById("target").textContent = data.targetUrl;

                // CPU 环图
                const cpuPercent = parseFloat(data.cpu);
                const cpuDash = (cpuPercent / 100 * 314).toFixed(1);
                document.getElementById("cpu-circle").setAttribute("stroke-dasharray", `${cpuDash} 314`);
                document.getElementById("cpu-text").textContent = `${cpuPercent}%`;

                // 内存环图
                const memUsed = ((data.memory.total - data.memory.free) / data.memory.total * 100).toFixed(1);
                const memDash = (memUsed / 100 * 314).toFixed(1);
                document.getElementById("mem-circle").setAttribute("stroke-dasharray", `${memDash} 314`);
                document.getElementById("mem-text").textContent = `${memUsed}%`;
            });

        fetch("/alarm-log")
            .then(res => res.json())
            .then(logs => {
                const ul = document.getElementById("logs");
                logs.forEach(log => {
                    const li = document.createElement("li");
                    li.textContent = `[${log.time}] ${JSON.stringify(log.data)}`;
                    ul.appendChild(li);
                });
            });

        fetch("/system-info")
            .then(res => {
                if (res.status === 401) {
                    window.location.href = "/login.html";
                    return;
                }
                return res.json();
            })
            .then(data => {
                // 处理数据
            })
            .catch(err => {
                console.error("请求失败", err);
            });
        function loadAlarmLogs() {
            fetch("/alarm-log")
                .then(res => {
                    if (res.status === 401) {
                        window.location.href = "/login.html";
                        return;
                    }
                    return res.json();
                })
                .then(logs => {
                    const ul = document.getElementById("logs");
                    ul.innerHTML = ""; // 清空旧内容
                    logs.forEach(log => {
                        const li = document.createElement("li");
                        li.textContent = `[${log.time}] ${JSON.stringify(log.data)}`;
                        ul.appendChild(li);
                    });
                });
        }

        // 初次加载
        loadAlarmLogs();

        // 每隔 5 秒自动刷新
        setInterval(loadAlarmLogs, 5000);


    </script>
</body>

</html>